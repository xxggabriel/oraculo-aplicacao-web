version: '3.9'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: oraculo-app:latest
    networks:
      - default
      - shared_etl_api
    env_file:
      - .env
    environment:
      APP_ENV: production
      APP_DEBUG: 'false'
      APP_URL: http://localhost
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      SESSION_DRIVER: file
      ELASTICSEARCH_SCHEME: ${ELASTICSEARCH_SCHEME:-http}
      ELASTICSEARCH_HOST: ${ELASTICSEARCH_HOST:-elasticsearch}
      ELASTICSEARCH_PORT: ${ELASTICSEARCH_PORT:-9200}
      ELASTICSEARCH_INDEX: ${ELASTICSEARCH_INDEX:-itens-normalizados}
    volumes:
      - storage:/var/www/html/storage
      - sqlite:/var/www/html/database
      - public:/var/www/html/public
    expose:
      - "9000"

  web:
    image: nginx:1.27-alpine
    depends_on:
      - app
    ports:
      - "8085:80"
    networks:
      - default
      - shared_etl_api
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - public:/var/www/html/public:ro
      - storage:/var/www/html/storage:ro

  # search:
  #   image: opensearchproject/opensearch:2.17.0
  #   profiles: ["search"]
  #   environment:
  #     discovery.type: single-node
  #     plugins.security.disabled: 'true'
  #     OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
  #   ports:
  #     - "9200:9200"
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -s http://localhost:9200 >/dev/null || exit 1"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  storage:
  sqlite:
  public:

networks:
  shared_etl_api:
    external: true
    name: ${ETL_API_NETWORK:-diarios_default}
